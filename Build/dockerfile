FROM debian:bookworm

RUN set -xe \
    echo '#!/bin/sh' > /usr/sbin/policy-rc.d \
    echo 'exit 101' >> /usr/sbin/policy-rc.d \
    chmod +x /usr/sbin/policy-rc.d \
    dpkg-divert --local --rename --add /sbin/initctl \
    cp -a /usr/sbin/policy-rc.d /sbin/initctl \
    sed -i 's/^exit.*/exit 0/' /sbin/initctl \
    echo 'force-unsafe-io' > /etc/dpkg/dpkg.cfg.d/docker-apt-speedup \
    echo 'DPkg::Post-Invoke { "rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true"; };' > /etc/apt/apt.conf.d/docker-clean \
    echo 'APT::Update::Post-Invoke { "rm -f /var/cache/apt/archives/*.deb /var/cache/apt/archives/partial/*.deb /var/cache/apt/*.bin || true"; };' >> /etc/apt/apt.conf.d/docker-clean \
    echo 'Dir::Cache::pkgcache ""; Dir::Cache::srcpkgcache "";' >> /etc/apt/apt.conf.d/docker-clean \
    echo 'Acquire::Languages "none";' > /etc/apt/apt.conf.d/docker-no-languages \
    echo 'Acquire::GzipIndexes "true"; Acquire::CompressionTypes::Order:: "gz";' > /etc/apt/apt.conf.d/docker-gzip-indexes \
    echo 'Apt::AutoRemove::SuggestsImportant "false";' > /etc/apt/apt.conf.d/docker-autoremove-suggests \
    echo 'APT::Keep-Downloaded-Packages "false";' > /etc/apt/apt.conf.d/docker-disable-cache \
    echo 'APT::Clean-Installed "true"' > /etc/apt/apt.conf.d/docker-clean-installed

SHELL [ "/bin/bash", "-c" ]
ENV TERM=xterm
ENV SHELL=bash
ENV DEBIAN_FRONTEND=noninteractive

WORKDIR /app

RUN apt-get update \
    && apt-get install -y default-mysql-client apache2 python3-dev default-libmysqlclient-dev build-essential \
      python3-minimal python3-pip supervisor

COPY requirements.txt ./

RUN cat requirements.txt \
    && python3 -m pip install -r requirements.txt --break-system-packages --no-cache-dir  \
    && rm -f requirements.txt

COPY ./Build/apache2/conf-available/* /etc/apache2/conf-available/
COPY ./Build/apache2/sites-available/* /etc/apache2/sites-available/
COPY ./Build/apache2/mods-available/* /etc/apache2/mods-available/

COPY ./app/bin ./bin/
COPY ./app/public_html ./public_html/

RUN rm /var/log/apache2/access.log /var/log/apache2/error.log \
    && ln -s /dev/stdout /var/log/apache2/access.log \
    && ln -s /dev/stderr /var/log/apache2/error.log \
    && a2enconf cgi.conf \
    && a2dismod -f dir \
    && a2enmod cgi dir \
    && rm -rf /var/www/html/* \
    && ln -s /app/public_html/ /var/www/html \
    && chown -R www-data:www-data /var/www/html/*

COPY ./Build/supervisor.conf /etc/supervisor/conf.d/supervisord.conf

# fixing any windows crlf perms
RUN apt-get update \
    && apt-get install -y dos2unix \
    && find /app -type f -print0 | xargs -0 dos2unix -- \
    && apt-get remove --purge -y dos2unix


RUN apt-get update \
    && apt-get install -y vim

EXPOSE 80
CMD [ "/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf" ]